const Promise = require('bluebird');
const Sqlite = require('sqlite-pool');
const config = require('../../conf');
const path = require('path');
const {log, error} = require('debugger')("utils");

let sqlConnection;

function dbPath() {
    let result;
    switch (config.get('db-env')) {
        case "dev":
            result = path.resolve(__dirname, '../..', "db/dev.sqlite");
	        log(`result '${result}'`);
            break;
        case "prod":
            result = path.resolve(__dirname, '../..', "db/prod.sqlite");
	        log(`result '${result}'`);
            break;
        default:   
            result = "";
	    log(`result '${result}'`)
    }
    log(`[getDbPath][spath] ${result}`);
    return result;
}

function getDB() {
    if (!sqlConnection) {
        sqlConnection = new Sqlite(dbPath(), {Promise});
        log(`connected`);
    }
    log(`return`);
    return sqlConnection;
}

process.on('SIGINT', () => {
    log(`close`);
    sqlConnection.close();
    process.exit(0);
});

module.exports = {
    dbPath,
    getDB
};
